package nl.vpro.semantic;

import io.micrometer.core.instrument.logging.LoggingMeterRegistry;
import lombok.extern.slf4j.Slf4j;

import java.time.Duration;

import org.junit.jupiter.api.Test;

import com.github.tomakehurst.wiremock.client.WireMock;
import com.github.tomakehurst.wiremock.junit5.WireMockRuntimeInfo;
import com.github.tomakehurst.wiremock.junit5.WireMockTest;

import static org.assertj.core.api.Assertions.assertThat;


@Slf4j
@WireMockTest
class ApiVectorizationServiceImplTest {

    @Test
    void forQuery(WireMockRuntimeInfo runtimeInfo) {
        float[] vector = getImpl(runtimeInfo).forQuery("hallo daar");

        assertThat(vector).hasSize(512);

    }

    @Test
    void forText(WireMockRuntimeInfo runtimeInfo) {
        float[] vector = getImpl(runtimeInfo).forText("hallo daar");

        assertThat(vector).hasSize(512);

    }

    ApiVectorizationServiceImpl getImpl(WireMockRuntimeInfo runtimeInfo) {
        //return new ApiVectorizationServiceImpl("70ccf7c8-4dbc-4711-be57-a51a8a971cb3");

        WireMock.stubFor(
            WireMock.post("/vectorization").willReturn(WireMock.ok("{\"embedding\":[0.0485018715262413,0.011717514134943485,-0.03431199863553047,-0.06001341715455055,0.02442017011344433,0.010788839310407639,-0.0021697685588151217,-0.0552147701382637,-0.04709427058696747,0.002963996259495616,-0.005686370190232992,-0.07113896310329437,0.014658994041383266,0.005381841212511063,-0.0037438622675836086,0.02509588748216629,0.0482281893491745,0.049140263348817825,0.00842525064945221,0.021804379299283028,0.021178053691983223,-0.00107611995190382,0.0012156976154074073,-0.0017625261098146439,0.04346663877367973,0.024276142939925194,0.026709850877523422,-0.0535091795027256,-0.026574552059173584,-0.052570030093193054,-0.03255626931786537,0.004222075920552015,-0.014240795746445656,-0.06299915164709091,0.039313796907663345,-0.06415771692991257,-0.046071410179138184,-0.02519259974360466,0.027203166857361794,-0.008046453818678856,0.06733682006597519,-0.0160942655056715,-0.061873532831668854,0.031725674867630005,0.006522452458739281,0.044014252722263336,0.01728876493871212,0.038286060094833374,0.007531155366450548,0.010284592397511005,-0.0013516132021322846,0.012585429474711418,-0.020661430433392525,0.014069346711039543,-0.02345605567097664,-0.017015820369124413,-0.06519516557455063,0.003180352970957756,-0.026007797569036484,-0.04453375190496445,0.052083589136600494,-0.05910307541489601,-0.05950316786766052,-0.04101760685443878,0.0047946204431355,-0.020033083856105804,0.04690787196159363,0.01744838058948517,-0.022751929238438606,0.013915342278778553,-0.011195231229066849,0.022269954904913902,-0.005142904352396727,0.033573757857084274,0.00281986384652555,0.029679713770747185,0.016547976061701775,-0.009818150661885738,-0.058595724403858185,-0.006001520901918411,0.005048995837569237,-0.04982059821486473,-0.03707059845328331,0.05176554620265961,-0.04981609806418419,-0.017575951293110847,-0.016532815992832184,0.03592022508382797,-0.019487997516989708,-0.0013743365416303277,-0.0015050305519253016,0.004115352872759104,-0.0744289755821228,0.05841056630015373,0.01206071674823761,0.14264562726020813,-0.04829441010951996,0.022284982725977898,0.025279924273490906,-0.04131593927741051,-0.06093708425760269,0.03163127228617668,0.025193773210048676,0.023378517478704453,0.031159166246652603,-0.00722911674529314,-0.0427231602370739,-0.019538426771759987,0.01657303422689438,0.023030029609799385,-0.002417514566332102,-0.03729265555739403,-0.08155499398708344,0.0348227433860302,0.035629600286483765,0.001393805374391377,-0.027649175375699997,-0.006078433245420456,-0.00011770427227020264,-0.02102215774357319,0.03289974108338356,0.00747842388227582,-0.044676296412944794,-0.016476154327392578,-0.014466733671724796,-0.023013731464743614,0.008193721994757652,-0.011618080548942089,0.0020622701849788427,-0.03834687918424606,0.02255203388631344,0.017465908080339432,-0.016212960705161095,-0.007094318047165871,0.00893329456448555,0.0564255565404892,0.0027411815244704485,0.022334760054945946,-0.011638453230261803,-0.03997960686683655,0.0450393408536911,0.008121311664581299,0.034576211124658585,0.023488253355026245,-0.023480070754885674,0.03892615810036659,-0.017258184030652046,0.10784371942281723,0.04702942445874214,0.018423274159431458,0.050037432461977005,-0.006076002959161997,0.052881717681884766,-0.009524879045784473,0.0009226554539054632,0.01403352152556181,-0.04510236158967018,-0.013449576683342457,0.043911226093769073,0.0383351631462574,0.018106333911418915,0.03566141799092293,-0.03828193619847298,0.003291310975328088,-0.0012824422447010875,0.012877646833658218,0.04577447101473808,0.07138736546039581,-0.02039172500371933,-0.041293371468782425,0.020316390320658684,0.08783475309610367,-0.043504856526851654,0.015041498467326164,0.06351885944604874,0.012261094525456429,0.011361045762896538,0.00781302060931921,-0.06473522633314133,-0.006780262570828199,0.023420684039592743,-0.027423372492194176,0.04381495714187622,-0.03002600371837616,-0.031549423933029175,0.0013070122804492712,-0.0571095235645771,-0.005794286262243986,0.036702655255794525,-0.08727198094129562,-0.057081256061792374,-0.03432567045092583,0.014338298700749874,0.05471719056367874,-0.006514541804790497,-0.006113853305578232,-0.0739462599158287,0.0070861023850739,-0.02949267253279686,-0.0034691980108618736,0.06835025548934937,-0.1256653517484665,-0.051339562982320786,-0.06408307701349258,0.10509072244167328,0.03570738434791565,-0.00499079842120409,-0.017229055985808372,0.018267419189214706,-0.003552275011315942,0.021485278382897377,0.007126128301024437,-0.03243628889322281,0.07788299024105072,0.00971391424536705,0.017413480207324028,0.0060243867337703705,-0.02154853567481041,-0.03381475806236267,0.011837046593427658,0.035845816135406494,0.017641227692365646,-0.03535602241754532,0.038537219166755676,0.005842654500156641,-0.027273740619421005,-0.01883416809141636,0.04309317097067833,0.05951394885778427,0.05647241324186325,-0.03212858736515045,0.04819367080926895,0.00012587127275764942,-0.022805465385317802,0.012306850403547287,0.05708124116063118,0.022904573008418083,0.005197435617446899,-0.04463516175746918,0.0051714270375669,0.0018731054151430726,-0.03210827708244324,0.02890210784971714,-0.01080523245036602,0.0409877635538578,0.01847884990274906,0.023015713319182396,-0.005174197256565094,-0.0037525827065110207,0.05937739089131355,0.04295552149415016,-0.003904997603967786,0.02867909148335457,0.010038299486041069,-0.01916263811290264,-0.013956091366708279,0.03925015777349472,-0.0071379817090928555,0.009917309507727623,0.004760469309985638,-0.05202936381101608,0.0025721811689436436,0.050354935228824615,-0.018048901110887527,0.023973528295755386,-0.06114143133163452,-0.018135933205485344,-0.016610831022262573,-0.07000061124563217,-0.06103704497218132,0.026523856446146965,0.03403111547231674,0.028644129633903503,0.050885770469903946,0.08469735831022263,-0.021640172228217125,0.0402010977268219,0.0466923750936985,0.0029332281555980444,0.006131717003881931,0.006727252155542374,-0.017229199409484863,-0.0009982871124520898,-0.043183084577322006,0.0011961156269535422,-0.004421607591211796,-0.08911262452602386,-0.06126611679792404,0.005398257169872522,-0.03772016987204552,-0.03290369734168053,-0.049529630690813065,-0.041285187005996704,-0.037549618631601334,0.025273095816373825,0.011519201099872589,0.046821970492601395,0.03644530475139618,-0.03574035316705704,-0.043389007449150085,0.024255506694316864,0.0002786526456475258,-0.0056306119076907635,0.018447352573275566,-0.03604607656598091,-0.007487270049750805,-0.0457470677793026,0.012044429779052734,-0.06239546090364456,0.041144777089357376,0.004844523500651121,0.04350078105926514,0.011288546025753021,-0.06959299743175507,0.025710921734571457,-0.002286757342517376,-0.017856566235423088,0.00757593335583806,-0.021081862971186638,0.037319082766771317,-0.018303625285625458,-0.03064871020615101,0.05571651831269264,-0.01864338293671608,0.0672813430428505,-0.0552482008934021,-0.04214869439601898,0.04030540585517883,0.008266899734735489,0.015680700540542603,-0.026223888620734215,0.04574277624487877,0.042317863553762436,0.005212503485381603,-0.017183519899845123,-0.021892160177230835,-0.025761442258954048,0.03453200310468674,0.03881194442510605,-0.04982021450996399,-0.00847841426730156,-0.050717830657958984,0.013313671573996544,-0.012086254544556141,0.049438271671533585,-0.0023021046072244644,-0.10264870524406433,-0.0025832136161625385,-0.021575432270765305,0.02155189961194992,-0.03446686267852783,0.010810481384396553,-0.07242590188980103,-0.05868781730532646,-0.05685438588261604,-0.0052603851072490215,-0.09920725971460342,-0.03448829799890518,-0.016991959884762764,-0.011399392038583755,0.02115320973098278,-0.045982975512742996,0.03474951907992363,-0.010571788065135479,0.01999431848526001,0.0008491628104820848,0.03249146789312363,-0.0075621530413627625,-0.022204097360372543,-0.03705272823572159,-0.029508095234632492,-0.05320411175489426,0.0123364869505167,0.0008752749999985099,-0.03362172469496727,-0.035498324781656265,0.023455515503883362,-0.004091660026460886,-0.06619267165660858,0.035928234457969666,0.017451588064432144,0.010500114411115646,0.0224953293800354,0.04293287917971611,0.055804770439863205,-0.02953815832734108,0.042541515082120895,-0.03159589692950249,0.014353455044329166,-0.025424577295780182,0.023909153416752815,0.005063140764832497,-0.015725988894701004,0.0333796963095665,0.02571318857371807,0.04693162813782692,0.038509268313646317,-0.005905760917812586,0.007613959722220898,-0.0076297870837152,0.08005589246749878,0.04584726318717003,0.040635447949171066,0.03197912871837616,-0.01322612538933754,-0.019984854385256767,-0.04151672124862671,0.013367834500968456,-0.02223248966038227,-0.008741437457501888,0.003515728283673525,-0.013368776999413967,-0.03532816469669342,-0.040774211287498474,-0.0491926483809948,0.05541198328137398,0.014968683011829853,0.015739627182483673,-0.0023410897701978683,0.023494670167565346,0.026069238781929016,-0.01650635153055191,-0.012205325067043304,-0.042590174823999405,0.021068597212433815,0.01908339373767376,0.02726285718381405,-0.04423688352108002,0.0015849123010411859,-0.03848797827959061,-0.05114920437335968,0.012363272719085217,0.10140444338321686,0.005543816834688187,0.02471053972840309,0.021406235173344612,0.043175291270017624,-0.0139240100979805,0.03321206942200661,-0.025632426142692566,0.01610749028623104,-0.09364929050207138,-0.05887124314904213,0.010882333852350712,0.021277764812111855,-0.027046073228120804,-0.06963320076465607,0.010584574192762375,-0.011791651137173176,0.03218333423137665,-0.013186060823500156,-0.005027291364967823,0.05452483147382736,0.05467292293906212,-0.001437015482224524,-0.004956550430506468,-0.014751631766557693,0.02287302166223526,0.013208743184804916,0.013699060305953026,0.016465909779071808,0.02271205559372902,0.04775010421872139,0.006478296127170324,0.0007868824759498239,-0.005058495327830315,-0.0445384681224823,-0.035199303179979324,0.02043221890926361,-0.04745889827609062,-0.004192869644612074,-0.013449611142277718,-0.06688198447227478,0.03835228830575943,0.04650489240884781,0.04044285789132118,-0.014157815836369991,-0.04242866486310959,0.007992423139512539,0.02354418858885765,-0.0065300646238029,-0.0508149154484272,0.14445309340953827,0.033765945583581924,-0.01785786636173725,0.00724943308159709,-0.029302028939127922,0.02930881455540657,-0.037817854434251785,0.0339757464826107,-0.003522703889757395,-0.030549634248018265,0.026383355259895325,-0.009875833056867123,0.05138373002409935,-0.006324762478470802,-0.02166374959051609,-0.06409735977649689,-0.04381372779607773,-0.06369855254888535,0.004603836685419083,-0.011289727874100208,0.06497232615947723,0.0300632044672966,-0.015530538745224476,-0.02812204323709011,-0.015730630606412888,-0.006641601677983999,-2.8238107915967703e-05,0.022570112720131874,0.005278157535940409,-0.05246136710047722]}"))
        );
        return new ApiVectorizationServiceImpl(runtimeInfo.getHttpBaseUrl() + "/vectorization", "key!", new LoggingMeterRegistry(), Duration.ofSeconds(5));
    }
}

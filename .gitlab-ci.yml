---
variables:
  ES_IMAGE_NAME: poms-plus/es-builder-2
  REGISTRY: openshift-image-registry.apps.cluster.chp4.io
  INTERNAL_REGISTRY: image-registry.openshift-image-registry.svc:5000

.maven:
  services:
    - !reference [.opensearch, services]
  before_script:
    - !reference [.opensearch, script]
  variables:
    MAVEN_EXTRA_ARGS: '-Dinteg.http.eshost=opensearch'

trigger api:
  extends: .trigger_down_stream
  trigger:
    project: npo/api
    branch: main

trigger media-publish:
  extends: .trigger_down_stream
  trigger:
    project: npo/media-publish
    branch: main

trigger pages-publish:
  extends: .trigger_down_stream
  trigger:
    project: npo/pages-publish
    branch: main

package push-mappings docker:
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [ "" ]
  stage: build
  needs: [build]
  tags:
    - docker
  before_script: !reference [ .kaniko_build_setup, script ]
  script:
    - setup_kaniko
    - echo pom version $POM_VERSION
    - kaniko_execute push-es-mappings $POM_VERSION
  rules: !reference [.rules, build] # For packaging the same rules apply as for building. (just the build _itself_ needs to be successful then)


.push_es: &push_es
  stage: release
  image: docker.vpro.nl/vpro/openshift-helm:2.2.1
  needs: ["package push-mappings docker"]
  before_script: !reference [ .docker_build_setup, script ]
  script:
    - get_artifact_versions push-es-mappings $POM_VERSION
    - oc login --server=$OPENSHIFT_SERVER --token=$OPENSHIFT_TOKEN -n poms-util-$OS_ENV
    - oc -n poms-util-$OS_ENV delete pod es-builder || echo 'No previous es-builder instance found'
    - export PASSWORD="$(oc -n poms-stack-$OS_ENV get secret elasticsearch -o jsonpath="{['data']['password']}" | base64 --decode)"
    - echo $PASSWORD | sha256sum
    - |-
      oc run es-builder \
            --image=$INTERNAL_REGISTRY/$ES_IMAGE_NAME:dev \
            --image-pull-policy='Always' \
            --restart='Never' \
            --env HOST="$HOST" \
            --env USER="$USER" \
            --env PASSWORD="$PASSWORD" \
            --env CLUSTER="$CLUSTER" \
            --env EXPERIMENTAL="$EXPERIMENTAL" \
            -n poms-util-$OS_ENV


push-mappings test:
  <<: *push_es
  variables:
    OS_ENV: test
    HOST: https://vpc-poms-plus-elasticsearch-test-tu2husqhnj43tmsqnj2fvpi2hy.eu-central-1.es.amazonaws.com:443
    USER: elasticsearch
    CLUSTER: 755036500103:poms-plus-elasticsearch-test
    EXPERIMENTAL: 'true'
  rules: !reference [ .rules, deploy_test ]

push-mappings acc:
  <<: *push_es
  variables:
    OS_ENV: acc
    HOST: https://vpc-poms-plus-elasticsearch-acc-bk5ui3ubahkwhmygv7h7nqbti4.eu-central-1.es.amazonaws.com:443
    USER: elasticsearch
    CLUSTER: 755036500103:poms-plus-elasticsearch-acc
    EXPERIMENTAL: 'true'
  rules: !reference [ .rules, deploy_accept ]


publish-mappings prod:
  <<: *push_es
  variables:
    OS_ENV: prod
    HOST: https://vpc-poms-plus-elasticsearch-prod-syxdj6ehquy6ruls6f6zdccxyq.eu-central-1.es.amazonaws.com:443
    USER: elasticsearch
    CLUSTER: 755036500103:poms-plus-elasticsearch-prod
  rules: !reference [ .rules, deploy_production ]

include:
  - project: 'shared/gitlab/gitlab-templates'
    ref: 'tags/9.17'
    file: 'maven_release.yml'
  - project: 'shared/gitlab/gitlab-templates'
    ref: 'tags/9.17'
    file: 'util/elasticsearch_service.yml'
  - project: 'shared/gitlab/gitlab-templates'
    ref: 'tags/9.17'
    file: 'util/kaniko.yml'
